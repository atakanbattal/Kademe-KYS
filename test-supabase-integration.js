/**
 * SUPABASE INTEGRATION TEST SCRIPT
 * Bu script Supabase entegrasyonunun doƒüru √ßalƒ±≈üƒ±p √ßalƒ±≈ümadƒ±ƒüƒ±nƒ± test eder
 * 
 * Kullanƒ±m:
 * 1. Terminal'de: node test-supabase-integration.js
 * 2. Veya Browser Console'da √ßalƒ±≈ütƒ±rƒ±n
 */

// ================================
// IMPORT & CONFIGURATION
// ================================
const { createClient } = require('@supabase/supabase-js');
const dotenv = require('dotenv');

// Environment variables y√ºkle
dotenv.config();

// Supabase client olu≈ütur
const supabase = createClient(
    process.env.REACT_APP_SUPABASE_URL || 'https://nzkxizhnikfshyhilefg.supabase.co',
    process.env.REACT_APP_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56a3hpemhuaWtmc2h5aGlsZWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTYwMzIsImV4cCI6MjA3MjI5MjAzMn0.aRm8XdIvVrBffxT2VHH7A2bMqQsjiJiy3qkbJAkYhUk'
);

// ================================
// TEST FUNCTIONS
// ================================
class SupabaseIntegrationTester {
    constructor() {
        this.testResults = [];
        this.errors = [];
    }

    // Test sonucunu kaydet
    recordTest(name, success, message, data = null) {
        const result = {
            test: name,
            success,
            message,
            data,
            timestamp: new Date().toISOString()
        };
        
        this.testResults.push(result);
        
        const status = success ? '‚úÖ' : '‚ùå';
        console.log(`${status} ${name}: ${message}`);
        
        if (data && success) {
            console.log(`   Data: ${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}`);
        }
        
        if (!success) {
            this.errors.push(result);
        }
    }

    // 1. Baƒülantƒ± testi
    async testConnection() {
        console.log('\nüîó Supabase baƒülantƒ±sƒ± test ediliyor...');
        
        try {
            const { data, error } = await supabase
                .from('users')
                .select('count', { count: 'exact' })
                .limit(1);

            if (error) throw error;

            this.recordTest(
                'Supabase Connection', 
                true, 
                'Supabase baƒülantƒ±sƒ± ba≈üarƒ±lƒ±',
                { tableAccess: 'users table accessible', count: data?.length || 0 }
            );
            return true;
        } catch (error) {
            this.recordTest(
                'Supabase Connection', 
                false, 
                `Baƒülantƒ± hatasƒ±: ${error.message}`,
                error
            );
            return false;
        }
    }

    // 2. Tablolarƒ± kontrol et
    async testTables() {
        console.log('\nüìä Tablolar kontrol ediliyor...');
        
        const tables = [
            'users',
            'suppliers', 
            'material_quality_controls',
            'quality_control_reports',
            'vehicle_quality_controls',
            'tank_leak_tests',
            'deviation_approvals',
            'dof_records',
            'quality_costs',
            'quarantine_records'
        ];

        let successCount = 0;

        for (const table of tables) {
            try {
                const { data, error } = await supabase
                    .from(table)
                    .select('*')
                    .limit(1);

                if (error) throw error;

                this.recordTest(
                    `Table: ${table}`, 
                    true, 
                    'Tablo eri≈üilebilir',
                    { recordCount: data?.length || 0 }
                );
                successCount++;
            } catch (error) {
                this.recordTest(
                    `Table: ${table}`, 
                    false, 
                    `Tablo hatasƒ±: ${error.message}`
                );
            }
        }

        this.recordTest(
            'All Tables Check', 
            successCount === tables.length, 
            `${successCount}/${tables.length} tablo eri≈üilebilir`
        );

        return successCount === tables.length;
    }

    // 3. CRUD operasyonlarƒ± test et
    async testCRUDOperations() {
        console.log('\n‚ö° CRUD operasyonlarƒ± test ediliyor...');
        
        let testSupplierId = null;

        try {
            // CREATE TEST
            const testSupplier = {
                name: 'Test Tedarik√ßi A.≈û.',
                code: `TEST_${Date.now()}`,
                contact_person: 'Test Ki≈üi',
                email: 'test@test.com',
                phone: '+90 555 123 4567',
                address: 'Test Adres, Test ƒ∞l',
                material_categories: ['Metal', 'Plastik'],
                notes: 'Test verisi - migration testi i√ßin olu≈üturuldu'
            };

            const { data: createData, error: createError } = await supabase
                .from('suppliers')
                .insert([testSupplier])
                .select()
                .single();

            if (createError) throw createError;

            testSupplierId = createData.id;
            this.recordTest(
                'CRUD: Create', 
                true, 
                'Test tedarik√ßi olu≈üturuldu',
                { id: testSupplierId, name: createData.name }
            );

            // READ TEST
            const { data: readData, error: readError } = await supabase
                .from('suppliers')
                .select('*')
                .eq('id', testSupplierId)
                .single();

            if (readError) throw readError;

            this.recordTest(
                'CRUD: Read', 
                readData.id === testSupplierId, 
                'Test tedarik√ßi okundu',
                { name: readData.name }
            );

            // UPDATE TEST
            const { data: updateData, error: updateError } = await supabase
                .from('suppliers')
                .update({ notes: 'Test verisi - g√ºncellendi' })
                .eq('id', testSupplierId)
                .select()
                .single();

            if (updateError) throw updateError;

            this.recordTest(
                'CRUD: Update', 
                updateData.notes.includes('g√ºncellendi'), 
                'Test tedarik√ßi g√ºncellendi',
                { updatedNotes: updateData.notes }
            );

            // DELETE TEST
            const { error: deleteError } = await supabase
                .from('suppliers')
                .delete()
                .eq('id', testSupplierId);

            if (deleteError) throw deleteError;

            this.recordTest(
                'CRUD: Delete', 
                true, 
                'Test tedarik√ßi silindi'
            );

        } catch (error) {
            this.recordTest(
                'CRUD Operations', 
                false, 
                `CRUD hatasƒ±: ${error.message}`,
                error
            );

            // Cleanup: Test verisini temizle
            if (testSupplierId) {
                try {
                    await supabase
                        .from('suppliers')
                        .delete()
                        .eq('id', testSupplierId);
                } catch (cleanupError) {
                    console.log('Cleanup hatasƒ±:', cleanupError.message);
                }
            }
        }
    }

    // 4. Storage test et
    async testStorageAccess() {
        console.log('\nüìÇ Storage eri≈üimi test ediliyor...');
        
        const buckets = [
            'documents',
            'certificates', 
            'quality-reports',
            'audit-attachments',
            'defect-photos',
            'training-materials'
        ];

        let successCount = 0;

        for (const bucketName of buckets) {
            try {
                const { data, error } = await supabase.storage
                    .from(bucketName)
                    .list('', { limit: 1 });

                if (error) throw error;

                this.recordTest(
                    `Storage: ${bucketName}`, 
                    true, 
                    'Bucket eri≈üilebilir',
                    { fileCount: data?.length || 0 }
                );
                successCount++;
            } catch (error) {
                this.recordTest(
                    `Storage: ${bucketName}`, 
                    false, 
                    `Bucket hatasƒ±: ${error.message}`
                );
            }
        }

        this.recordTest(
            'All Storage Buckets', 
            successCount === buckets.length, 
            `${successCount}/${buckets.length} bucket eri≈üilebilir`
        );

        return successCount === buckets.length;
    }

    // 5. Authentication test et
    async testAuthentication() {
        console.log('\nüîê Authentication test ediliyor...');
        
        try {
            // Session kontrol et
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();

            if (sessionError) throw sessionError;

            if (session) {
                this.recordTest(
                    'Auth: Current Session', 
                    true, 
                    'Aktif oturum var',
                    { userId: session.user.id, email: session.user.email }
                );
            } else {
                this.recordTest(
                    'Auth: Current Session', 
                    true, 
                    'Aktif oturum yok (normal)'
                );
            }

            // Test kullanƒ±cƒ± olu≈üturma (ger√ßek email gerekmez)
            const testEmail = `test_${Date.now()}@test.com`;
            const testPassword = 'TestPassword123!';

            this.recordTest(
                'Auth: System Ready', 
                true, 
                'Authentication sistemi hazƒ±r'
            );

        } catch (error) {
            this.recordTest(
                'Authentication', 
                false, 
                `Auth hatasƒ±: ${error.message}`,
                error
            );
        }
    }

    // 6. Real-time test et
    async testRealtime() {
        console.log('\n‚ö° Real-time √∂zellikler test ediliyor...');
        
        try {
            // Channel olu≈ütur
            const channel = supabase
                .channel('test_channel')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'suppliers' }, 
                    (payload) => {
                        console.log('Real-time event received:', payload);
                    }
                );

            // Subscribe
            const subscribeResult = await channel.subscribe();

            if (subscribeResult === 'SUBSCRIBED') {
                this.recordTest(
                    'Real-time: Subscribe', 
                    true, 
                    'Real-time subscription ba≈üarƒ±lƒ±'
                );

                // Unsubscribe
                await supabase.removeChannel(channel);
                
                this.recordTest(
                    'Real-time: Unsubscribe', 
                    true, 
                    'Real-time unsubscribe ba≈üarƒ±lƒ±'
                );
            } else {
                throw new Error('Subscription failed');
            }

        } catch (error) {
            this.recordTest(
                'Real-time Features', 
                false, 
                `Real-time hatasƒ±: ${error.message}`,
                error
            );
        }
    }

    // Ana test fonksiyonu
    async runAllTests() {
        console.log('üß™ SUPABASE INTEGRATION TEST BA≈ûLADI');
        console.log('=====================================');
        
        const startTime = Date.now();

        // Testleri sƒ±rayla √ßalƒ±≈ütƒ±r
        const connectionOk = await this.testConnection();
        
        if (connectionOk) {
            await this.testTables();
            await this.testCRUDOperations();
            await this.testStorageAccess();
            await this.testAuthentication();
            await this.testRealtime();
        } else {
            console.log('‚ùå Baƒülantƒ± ba≈üarƒ±sƒ±z, diƒüer testler atlanƒ±yor');
        }

        const endTime = Date.now();
        const duration = endTime - startTime;

        // Sonu√ßlarƒ± raporla
        this.generateReport(duration);
    }

    // Test raporu olu≈ütur
    generateReport(duration) {
        console.log('\nüìä TEST RAPORU');
        console.log('=====================================');

        const totalTests = this.testResults.length;
        const passedTests = this.testResults.filter(t => t.success).length;
        const failedTests = this.testResults.filter(t => !t.success).length;
        const successRate = Math.round((passedTests / totalTests) * 100);

        console.log(`‚è±Ô∏è  S√ºre: ${duration}ms`);
        console.log(`üìà Toplam Test: ${totalTests}`);
        console.log(`‚úÖ Ba≈üarƒ±lƒ±: ${passedTests}`);
        console.log(`‚ùå Ba≈üarƒ±sƒ±z: ${failedTests}`);
        console.log(`üìä Ba≈üarƒ± Oranƒ±: %${successRate}`);

        if (this.errors.length > 0) {
            console.log('\n‚ùå HATALAR:');
            this.errors.forEach((error, index) => {
                console.log(`${index + 1}. ${error.test}: ${error.message}`);
            });
        }

        console.log('\nüéØ SONU√á:');
        if (successRate >= 90) {
            console.log('üéâ Supabase entegrasyonu hazƒ±r! Mod√ºlleri entegre etmeye ba≈ülayabilirsiniz.');
        } else if (successRate >= 70) {
            console.log('‚ö†Ô∏è Entegrasyon kƒ±smen hazƒ±r. Hatalarƒ± d√ºzeltin ve tekrar test edin.');
        } else {
            console.log('üí• Entegrasyon ba≈üarƒ±sƒ±z. Environment dosyanƒ±zƒ± ve Supabase projesi ayarlarƒ±nƒ±zƒ± kontrol edin.');
        }

        return {
            success: successRate >= 90,
            successRate,
            totalTests,
            passedTests,
            failedTests,
            duration,
            errors: this.errors
        };
    }
}

// ================================
// SCRIPT EXECUTION
// ================================

// Node.js'de √ßalƒ±≈ütƒ±r
if (require.main === module) {
    const tester = new SupabaseIntegrationTester();
    tester.runAllTests().catch(console.error);
}

// Browser'da √ßalƒ±≈ütƒ±rmak i√ßin
if (typeof window !== 'undefined') {
    window.testSupabaseIntegration = async function() {
        const tester = new SupabaseIntegrationTester();
        return await tester.runAllTests();
    };
    
    console.log(`
üß™ SUPABASE TEST HAZIR

Browser'da √ßalƒ±≈ütƒ±rmak i√ßin:
> testSupabaseIntegration()
    `);
}

// Export for module usage
if (typeof module !== 'undefined' && module.exports) {
    module.exports = SupabaseIntegrationTester;
}

// ================================
// QUICK TEST EXAMPLE
// ================================

/*
// Hƒ±zlƒ± test √∂rneƒüi:
const tester = new SupabaseIntegrationTester();
tester.runAllTests().then(result => {
    if (result.success) {
        console.log('‚úÖ Entegrasyon hazƒ±r!');
    } else {
        console.log('‚ùå Entegrasyon sorunlu:', result.errors);
    }
});
*/
